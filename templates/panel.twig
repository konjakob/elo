{% extends 'default.twig' %}

{% block vars %}
{% endblock %}

{% block default %}

<div id="popup" style="display:none; "><div id="popupclose" onClick="tgldiv('popup');"><strong>X</strong></a></div><div id="popupcontent"></div></div>


<div class="uk-child-width-1-2@m uk-child-width-1-1@s uk-margin-top" uk-grid>
{% if 'CREATE_NEW_USER' in user_rights|keys %}

<div>
	<div class="uk-card uk-card-default uk-card-body">
		<h2 class="uk-card-title">New user</h2>
		<form class="uk-form-stacked" action="{{ current_url }}" method="post">

			<div class="uk-margin">
				<label class="uk-form-label" for="user_name">Name</label>
				<div class="uk-form-controls">
					<input class="uk-input" id="user_name" type="text" name="t_name" placeholder="Name">
				</div>
			</div>
			<div class="uk-margin">
				<label class="uk-form-label" for="user_email">Email</label>
				<div class="uk-form-controls">
					<input class="uk-input" id="user_email" type="text" name="t_email" placeholder="Email">
				</div>
			</div>
			<div class="uk-margin">
				<label class="uk-form-label" for="user_pass">Password</label>
				<div class="uk-form-controls">
						<input class="uk-input" id="user_pass" type="text" name="t_pass" placeholder="Password">
				</div>
				 {{ constant('PANEL_EXAMPLE_PASSWORD') }} <code id="suggestedPassword">{{ exampleCode }}</code> <small><a href="#" id="use-sug-password">Use this password</a></small>
			</div>
			<div class="uk-margin">
				<label class="uk-form-label" for="user_reg_email">Send registration email</label>
				<div class="uk-form-controls">
					<input class="uk-checkbox" id="user_reg_email" type="checkbox" name="t_send_email">
				</div>
			</div>
			<div class="uk-margin">
				<label class="uk-form-label" for="user_lang">Language</label>
				<div class="uk-form-controls">
					<select name="t_lang" class="uk-select" id="user_lang">
		{% for l in langs %}
			<option value="{{ l.lang_id }}">{{ l.lang_name }}</option>
		{% endfor %}
		</select>
				</div>
			</div>
			<div class="uk-text-right">
				<input type="submit" value="Save" name="new_user" class="uk-button uk-button-primary" />
			</div>
		</form>
	</div>
</div>
{% endif %}

{% if 'CREATE_NEW_RIGHT' in user_rights|keys %}

{% if saved_new_right %}
<div id='correct'>Saved the new right.</div>
{% endif %}

<div>
	<div class="uk-card uk-card-default uk-card-body uk-margin">
		<h2 class="uk-card-title">New right</h2>
		<form action="{{ current_url }}" class="uk-form-stacked" method="post">
			<div class="uk-margin">
				<label class="uk-form-label" for="right_name">Name</label>
				<div class="uk-form-controls">
					<input class="uk-input" id="right_name" type="text" name="t_name" placeholder="Name">
				</div>
			</div>
			<div class="uk-margin">
				<label class="uk-form-label" for="right_key">Key</label>
				<div class="uk-form-controls">
					<input class="uk-input" id="right_key" type="text" name="t_key" placeholder="Key">
				</div>
			</div>
			<div class="uk-text-right">
				<input type="submit" value="Save" name="new_right" class="uk-button uk-button-primary" />
			</div>
		</form>
	</div>
</div>
{% endif %}

{{ msg_group }}


{% if 'CREATE_GROUPS' in user_rights|keys %}	
<div>
	<div class="uk-card uk-card-default uk-card-body uk-margin">
		<h2 class="uk-card-title">New Group</h2>
		<form action="{{ current_url }}" class="uk-form-stacked" method="post">
			<div class="uk-margin">
				<label class="uk-form-label" for="group_name">Name</label>
				<div class="uk-form-controls">
					<input class="uk-input" id="group_name" type="text" name="t_group" placeholder="Name">
				</div>
			</div>
			<div class="uk-text-right">
				<input type="submit" value="Save" name="new_group" class="uk-button uk-button-primary" />
			</div>
		</form>
	</div>
</div>
{% endif %}

<div>
	<div class="uk-card uk-card-default uk-card-body uk-margin">
		<h2 class="uk-card-title">Groups</h2>
{% for g in groups %}
	<a onclick="javascript:loadGroupData({{ g.group_id }});javascript:tgldiv('popup');">{{ g.group_name }}</a>
	(<a href='{{ current_url }}?delete_group={{ g.group_id }}'>Delete</a> | <a onclick="javascript:changeGroupData({{ g.group_id }});javascript:tgldiv('popup');">Modify</a>)<br>

{% endfor %}
	</div>			
</div>
<div>
	<div class="uk-card uk-card-default uk-card-body uk-margin">
		<h2 class="uk-card-title">Edit users</h2>
		<div class="uk-column-1-2">
			<ul class="uk-list">
			{% for u in users %}
				<li><a onclick="javascript:loadUserData({{ u.user_id }});">{{ u.user_name }}</a></li>
			{% endfor %}
			</ul>
		</div>
</div></div>

</div>
		
<a name="newtopic"></a>

{% for m in msgs %}

<div class="uk-alert-{% if m.state == 'ok' %}success{% else %}danger{% endif %}" uk-alert>
    <a class="uk-alert-close" uk-close></a>
    <p>{{ m.text }}</p>
</div>

{% endfor %}

	<div class="uk-card uk-card-default uk-card-body uk-margin">
		<h2 class="uk-card-title">New topic</h2>

<form action="{{ current_url }}#newtopic" method="post" class="uk-form-stacked" enctype="multipart/form-data"  onsubmit="selectAllOptions('t_user');selectAllOptions('t_group');">

<div class="uk-child-width-1-2" uk-grid>
	<div>
		<div class="uk-card uk-card-small">
			<h4 class="uk-card-title">Users</h4>
			<p><table><tr><td>Existing user:</td><td></td><td>User for this topic:</td></tr><tr><td>
	<select id='ex_users' size='5' multiple='multiple' class="uk-select">
		{% for u in users %}
			<option value='{{ u.user_id }}'>{{ u.user_name }}</option>
		{% endfor %}
	</select></td>
	<td><input type="button" class="uk-button uk-margin-bottom uk-button-small" value=">>" onClick="javascript:addUserTopic();"><br><input class="uk-button uk-button-small" type="button" value="<<" onClick="javascript:removeUserTopic();"></td><td><select id='t_user' class="uk-select" size='5' multiple='multiple' name='t_user[]'></select></td></tr></table></p>
		</div>
	</div>
	<div>
		<div class="uk-card  uk-card-small">
			<h4 class="uk-card-title">Groups</h4>
			<p><table><tr><td>Existing groups:</td><td></td><td>Groups for this topic:</td></tr><tr><td><select id='ex_groups' class="uk-select" size='5' multiple='multiple'>
	{% for g in groups %}
	<option value='{{ g.group_id }}'>{{ g.group_name }}</option>
	{% endfor %}</select></td>
	<td><input type="button" class="uk-button uk-margin-bottom uk-button-small" value=">>" onClick="javascript:addGroupTopic();"><br><input type="button" class="uk-button uk-button-small" value="<<" onClick="javascript:removeGroupTopic();"></td><td><select id='t_group' size='5' class="uk-select" multiple='multiple' name='t_group[]'></select></td></tr></table></p>
		</div>
	</div>
</div>
		
	{% include 'partials/texttitleblock.twig' %}				

	{% if 'CREATE_SHEETS' in user_rights|keys %}
		{% include 'partials/cheatsheet.twig' %}
	{% endif %}
	{% if 'CREATE_ATTACHMENTS' in user_rights|keys %}
		{% include 'partials/attachment.twig' %}						
	{% endif %}

	<div class="uk-text-right">
		<input class="uk-button uk-button-primary" type="submit" value="Save" name="new_topic" />
	</div>
</form>
</div>
	

<div id="edit-user-model" uk-modal>
    <div class="uk-modal-dialog uk-modal-body">
        <h2 class="uk-modal-title" id="modal-headline">Edit User</h2>
        <p>
		
			<form class="uk-form-stacked" action="{{ current_url }}" method="post">
				<input type="hidden" name="user_id_c" value="">
				<div class="uk-margin">
					<label class="uk-form-label" for="user_name_c">Name</label>
					<div class="uk-form-controls">
						<input class="uk-input" id="t_name_c" type="text" name="t_name_c">
					</div>
				</div>
				<div class="uk-margin">
					<label class="uk-form-label" for="user_email_c">Email</label>
					<div class="uk-form-controls">
						<input class="uk-input" id="user_email_c" type="text" name="t_email_c">
					</div>
				</div>
				<div class="uk-margin">
					<label class="uk-form-label" for="user_pass_c">Password</label>
					<div class="uk-form-controls">
							<input class="uk-input" id="user_pass_c" type="text" name="t_pass_c">
					</div>
					 {{ constant('PANEL_EXAMPLE_PASSWORD') }} <code id="suggestedPassword_existing"></code> <small><a href="#" id="use-sug-password_existing">Use this password</a></small>
				</div>
				<div class="uk-margin">
					<label class="uk-form-label" for="user_lang_c">Language</label>
					<div class="uk-form-controls">
						<select name="t_lang_c" class="uk-select" id="user_lang_c">
						{% for l in langs %}
							<option value="{{ l.lang_id }}">{{ l.lang_name }}</option>
						{% endfor %}
						</select>
					</div>
				</div>
				<div class="uk-text-right">
					<input type="submit" value="Save" name="new_user_c" class="uk-button uk-button-primary" />
				</div>
			</form>
			
			<div class="uk-child-width-1-1" uk-grid>
				<div>

					<table>
						<tr>
							<td>Existing rights:</td>
							<td></td>
							<td>User rights:</td>
						</tr>
						<tr>
							<td>
								<select id='ex_rights_c' size='5' multiple='multiple' class="uk-select">

								</select>
							</td>
							<td>
								<input type="button" value=">>" onClick="javascript:addRight();"><br><input type="button" value="<<" onClick="javascript:removeRight();">
							</td>
							<td>
								<select id='us_rights_c' size='5' multiple='multiple' class="uk-select"></select>
							</td>
						</tr>
					</table>
					
				</div>
				<div>
					<table>
						<tr>
							<td>Existing groups:</td>
							<td></td>
							<td>User groups:</td>
						</tr>
						<tr>
							<td>
								<select id='ex_groups_c' size='5' multiple='multiple' class="uk-select"></select>
							</td>
							<td>
								<input type="button" value=">>" onClick="javascript:addGroup();"><br><input type="button" value="<<" onClick="javascript:removeGroup();">
							</td>
							<td>
								<select id='us_groups_c' size='5' multiple='multiple' class="uk-select"></select>
							</td>				
						</tr>
					</table>
				</div>
			</div>
		
		</p>
    </div>
</div>
	
{% endblock %}		  

{% block footerInjection %}


<script language="javascript">  

   	function removeRight() {
		$.post("actions.php",
		{	  
		  userid:$('#user_id_c').val(),
		  action:'removeRight',
		  t_r:$("#us_rights_c").val()
		},
		function(data,status){
			$('#us_rights_c option:selected').each(function(){
				$("<option/>").val($(this).val()).text($(this).text()).prependTo("#ex_rights_c");
				$("#us_rights_c option[value="+$(this).val()+"]").remove();
			});
		});
	}
	function addRight() {
		$.post("actions.php",
		{	  
		  userid:$('#user_id_c').val(),
		  action:'addRight',
		  t_r:$("#ex_rights_c").val()
		},
		function(data,status){
			$('#ex_rights_c option:selected').each(function(){
				$("<option/>").val($(this).val()).text($(this).text()).prependTo("#us_rights_c");
				$("#ex_rights_c option[value="+$(this).val()+"]").remove();
			});
		});
	}
	function removeGroup() {
		$.post("actions.php",
		{	  
		  userid:$('#user_id_c').val(),
		  action:'removeGroup',
		  t_r:$("#us_groups_c").val()
		},
		function(data,status){
			$('#us_groups_c option:selected').each(function(){
				$("<option/>").val($(this).val()).text($(this).text()).prependTo("#ex_groups_c");
				$("#us_groups_c option[value="+$(this).val()+"]").remove();
			});
		});
	}
	function addGroup() {
		$.post("actions.php",
		{	  
		  userid:$('#user_id_c').val(),
		  action:'addGroup',
		  t_r:$("#ex_groups_c").val()
		},
		function(data,status){
			$('#ex_groups_c option:selected').each(function(){
				$("<option/>").val($(this).val()).text($(this).text()).prependTo("#us_groups_c");
				$("#ex_groups_c option[value="+$(this).val()+"]").remove();
			});
		});
	}

	$('#use-sug-password').click(function(e) {
		e.preventDefault();
		$('#user_pass').val($('#suggestedPassword').text());
	});

	function tgldiv(divname){
		$("#"+divname).slideToggle("slow");
	 };
  
	function loadUserData(id) {
		$.ajax({
				url: "actions.php?action=getUser&userid="+id,
				dataType: 'json',
				success: function(respond)
				{
					if ( respond.state == 'ok' ) {
						$('#t_name_c').val(respond.user_data.user_name);
						$('#user_email_c').val(respond.user_data.user_email);
						$("#user_lang_c option[id='" + respond.user_data.lang_id + "']").attr("selected", "selected");
						$('#user_id_c').val(respond.user_data.user_id);
						$('#suggestedPassword_existing').text(respond.exampleCode);
						$('#ex_rights_c').empty();
						$.each(respond.option_right_no,function(key, value) {
							$('#ex_rights_c').append('<option value=' + key + '>' + value + '</option>');
						});
						
						$('#us_rights_c').empty();
						$.each(respond.option_right_yes,function(key, value) {
							$('#us_rights_c').append('<option value=' + key + '>' + value + '</option>');
						});
						
						$('#ex_groups_c').empty();
						$.each(respond.option_group_no,function(key, value) {
							$('#ex_groups_c').append('<option value=' + key + '>' + value + '</option>');
						});
						
						$('#us_groups_c').empty();
						$.each(respond.option_group_yes,function(key, value) {
							$('#us_groups_c').append('<option value=' + key + '>' + value + '</option>');
						});
						
						//$('#modal-body').html(respond);
						UIkit.modal($('#edit-user-model')).show();
					} else {
						toastr["error"]("Error", "Error");
					}
					/*$("#popupcontent").html(respond);
					$("#popupcontent").find("script").each(function(i) {
						eval($(this).text());
					});*/
				}
		});
	}
  
  function loadGroupData(id) {
	  $.ajax({
				url: "actions.php?action=getGroupUser&group_id="+id,
				success: function(respond)
				{
					$("#popupcontent").html(respond);
					$("#popupcontent").find("script").each(function(i) {
                    	eval($(this).text());
                	});
				}
		});
  }
  
  function changeGroupData(id) {
	  $.ajax({
				url: "actions.php?action=getGroup&group_id="+id,
				success: function(respond)
				{
					$("#popupcontent").html(respond);
					$("#popupcontent").find("script").each(function(i) {
                    	eval($(this).text());
                	});
				}
		});
  }
  
     function removeUserTopic() {
		$(document).ready(function(){
			$('#t_user option:selected').each(function(){
				$("<option/>").val($(this).val()).text($(this).text()).prependTo("#ex_users");
				$("#t_user option[value="+$(this).val()+"]").remove();
			});
		});
	}
	function addUserTopic() {
		$(document).ready(function(){
			$('#ex_users option:selected').each(function(){
				$("<option/>").val($(this).val()).text($(this).text()).prependTo("#t_user");
				$("#ex_users option[value="+$(this).val()+"]").remove();
			});
		});
	}
	function removeGroupTopic() {
		$(document).ready(function(){
			$('#t_group option:selected').each(function(){
				$("<option/>").val($(this).val()).text($(this).text()).prependTo("#ex_groups");
				$("#t_group option[value="+$(this).val()+"]").remove();
			});
		});
	}
	function addGroupTopic() {
		$(document).ready(function(){
			$('#ex_groups option:selected').each(function(){
				$("<option/>").val($(this).val()).text($(this).text()).prependTo("#t_group");
				$("#ex_groups option[value="+$(this).val()+"]").remove();
			});
	  });
	}
	function selectAllOptions(selStr)
	{
	  var selObj = document.getElementById(selStr);
	  for (var i=0; i<selObj.options.length; i++) {
		selObj.options[i].selected = true;
	  }
	}
</script>

	{% if 'CREATE_SHEETS' in user_rights|keys %}
		<script type="text/javascript">
			window.onload = function() {	
				abc_editor = new ABCJS.Editor("abc", { paper_id: "paper0", midi_id:"midi", warnings_id:"warnings" });
			}
		</script>
	{% endif %}
			
{% endblock %}	
